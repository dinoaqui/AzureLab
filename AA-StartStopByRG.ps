workflow StartStopVMs{
    Param (
        [Parameter(Mandatory = $true)]
        [String]
        $RgName,
        [Parameter(Mandatory = $true)]
        [Boolean]
        $Shutdown
        )
        # Get the connection "AzureRunAsConnection"
        $servicePrincipalConnection = Get-AutomationConnection -Name 'AzureRunAsConnection'

        # Log in to Azure
        Connect-AzAccount -ServicePrincipal -TenantId $servicePrincipalConnection.TenantId -ApplicationId $servicePrincipalConnection.ApplicationId -CertificateThumbprint $servicePrincipalConnection.CertificateThumbprint

        # Get all VMs in the resource group
        $vms = Get-AzVM -ResourceGroupName $RgName

        # Iterate through the VMs in parallel
        Foreach -Parallel ($vm in $vms) {
            # If Shutdown equals True
            if ($Shutdown) {
                Write-Output "Stopping $($vm.Name)";
                Stop-AzVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName -Force;
            }
            # If Shutdown equals False
            else {
                Write-Output "Starting $($vm.Name)";
                Start-AzVM -Name $vm.Name -ResourceGroupName $vm.ResourceGroupName;
            }
        }
}
